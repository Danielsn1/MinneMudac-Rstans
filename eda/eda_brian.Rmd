---
title: "EDA"
author: "Brian Cochran"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries}
library(tidyverse)
library(fpp3)
library(glmnet)
library(ggthemes)
library(patchwork)
library(plyr)
library(sqldf)
theme_set(theme_economist())
```

```{r load_data}
sched2023 <- read.csv("~/MinneMudac-Rstans/data/2023_MLBSchedule.csv")
og_sched <- read.csv("~/MinneMudac-Rstans/data/OriginalSchedulesFixed.csv")
game_logs <- read.csv("~/MinneMudac-Rstans/data/GameLogsFixed.csv")
```

```{r eda-gamelogs}
game_logs <- game_logs %>%
  as_tibble() %>%
  mutate(Date=as.Date(as.character(Date), format="%Y%m%d")) %>%
  mutate(Attendance=Attendance/1000)

game_logs %>%
  filter(year(Date)==2001) %>%
  ggplot(aes(x=Date, y=Attendance))+
  geom_point()

str(game_logs)
```

```{r twins_streaks_eda1}
twins_logs <- game_logs %>%
  filter(HomeTeam=="MIN" | VisitingTeam=="MIN", Attendance>0) %>%
  mutate(win=ifelse(HomeTeam=="MIN", HomeTeamScore>VistingTeamScore, VistingTeamScore>HomeTeamScore))

countStreaks <- function(wins){
  streaks <- rep(0, length(wins))
  count <- 0
  for (i in 2:length(wins)){
    if (wins[i-1] == TRUE) {
      count = count + 1
    } else {
      count = 0
    }
    streaks[i] = streaks[i] + count
  }
  return(streaks)
}

twins_logs <- twins_logs %>%
  mutate(streak = countStreaks(win))

cor(twins_logs$Attendance, twins_logs$streak)
twins_logs %>%
  ggplot(aes(x=streak, y= Attendance))+
  geom_point()+
  geom_smooth()
```

It looks like win streak is not going to be a good predictor of attendance because the correlation is very low and the plot shows an almost horizontal line.

```{r twins_streaks_eda2}
twins_logs %>%
  group_by(streak) %>%
  ggplot(aes(x=Attendance, y=as.factor(streak)))+
  geom_boxplot()
```

The boxplot shows that from a streak of 1-10 there is not much difference in attendance, but at 11 there is a significant difference in attendance. There is not as much data for streaks of 11, though, so this may not be reliable.

```{r allteams_streaks}
all_logs <- twins_logs
for (team in unique(game_logs$HomeTeam)){
  temp <- game_logs %>%
    filter(HomeTeam==team | VisitingTeam==team, Attendance>0) %>%
    mutate(win=ifelse(HomeTeam==team, HomeTeamScore>VistingTeamScore, VistingTeamScore>HomeTeamScore))
  temp <- temp %>%
    mutate(streak=countStreaks(win))%>%
    filter(HomeTeam==team)
  all_logs <- rbind(all_logs, temp)
}
all_logs <- all_logs %>%
  select(-win)

(all_logs %>%
  ggplot(aes(x=Attendance, y=as.factor(streak)))+
  geom_boxplot()+
    labs(y="Win Streak")) |
(all_logs %>%
  ggplot(aes(x=streak, y=Attendance))+
  geom_point()+
  geom_smooth()+
   labs(x="Win Streak")) |
  plot_annotation(title="Relationship Between Win Streaks and Attendance")
cor(all_logs$Attendance, all_logs$streak)
```

```{r twins_visitingteams}
twins_logs %>%
  ggplot(aes(x=Attendance, y=VisitingTeam))+
  geom_boxplot()+
  labs(title="Attendance at Twins Home Games")
```

```{r weather_data}
#Create park codes and attach location identifier via mapvalues function
#The location identifier comes from a string in the weather station name
park_codes <- read.csv("~/MinneMudac-Rstans/data/parkcode.csv") %>%
  select(PARKID, CITY) %>%
  mutate(Loc=CITY)
names(park_codes) <- c("ParkID", "City", "Loc")
park_codes$Loc <- mapvalues(park_codes$Loc,
                            from=c("Collinwood", "Covington", "Dunedin", "Dyersville", "Geauga Lake", "Gloucester City", "Harrison", "Irondequoit", "Lake Buena Vista", "London", "Ludlow", "Maspeth", "Middletown", "Bloomington", "Newburgh Township", "Brooklyn", "Queens", "Providence", "Springfield", "Three Rivers", "Troy", "Warwick", "Watervliet", "Weehawken", "West New York", "New York"),
                            to=c("Cleveland", "Cincinnati", "Tampa", "Dubuque", "Cleveland", "Philadelphia", "Newark", "Rochester", "Orlando", "Heathrow", "Cincinnati", "JFK", "Hartford", "Minneapolis", "Evansville", "JFK", "JFK", "Rhode Island", "Hartford", "Syracuse", "Albany", "Rhode Island", "Albany", "JFK", "JFK", "JFK"))


#Combine two weather datasets into one
weather1 <- read.csv("~/MinneMudac-Rstans/data/weather1.csv")
weather2 <- read.csv("~/MinneMudac-Rstans/data/weather2.csv")
weather <- rbind(weather1, weather2) %>%
  select(DATE, PRCP, NAME) %>%
  mutate(DATE=as.Date(DATE))
names(weather) <- c("Date", "Prcp", "Name")


#Merge weather and park codes datasets to add ParkID column to weather
park_weather <- sqldf("
                      SELECT *
                      FROM weather, park_codes
                      WHERE Name LIKE '%'||Loc||'%'
                      ") %>%
  select(Date, Prcp, ParkID)


#Join park_weather and all_logs by ParkID and Date
all_logs <- all_logs %>%
  select(names(all_logs)[1:19])
all_logs <- merge(all_logs, park_weather, by.x=c("Date", "BallParkID"), by.y=c("Date", "ParkID"), all.x=TRUE)

#Create dummy variable for rain/no rain
all_logs <- all_logs %>%
  mutate(Rain=ifelse(Prcp>0, 1, 0))
```

```{r eda_weather1}
(all_logs %>%
  filter(!is.na(Prcp)) %>%
  ggplot(aes(x=Attendance, fill=as.factor(Rain)))+
  geom_density(alpha=0.5)+
   labs(y="Density", fill="")+
   scale_fill_discrete(labels=c("No Rain", "Rain"))) /
(all_logs %>%
   filter(!is.na(Prcp)) %>%
   mutate(Rain=ifelse(Rain==1, "Rain", "No Rain")) %>%
   ggplot(aes(x=Attendance, y=(Rain)))+
   geom_boxplot()+
   labs(y="")) /
  plot_annotation(title="Distribution of Attendance Based on Weather")
```

```{r eda_weather2}
all_logs %>%
  filter(!is.na(Prcp), Prcp>0) %>%
  ggplot(aes(x=Prcp, y=Attendance))+
  geom_point()+
  geom_smooth()
```