---
title: "Nathan EDA"
author: "Nathan Daniels"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r load-packages}
library(readr)
library(tidyverse)
library(tsibble)
library(GGally)
library(leaps)
library(glmnet)
```


```{r load-data}

schedules <- read_csv("../data/OriginalSchedules.csv", locale = locale(encoding = "utf-16"))
logs <- read_csv("../data/GameLogs.csv", locale = locale(encoding = "utf-16"))
mlb_schedule <- read_csv("../data/2023_MLBSchedule.csv")

```

Changed the dates into a R format

```{r create-timeseries}

schedules_tsibble <- schedules %>% 
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>%
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

logs_tsibble <- logs %>%
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>% 
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

mlb_schedule_tsibble <- mlb_schedule %>%
  mutate(game_date = as.Date(as.character(game_date), format="%Y%m%d")) %>%
  as_tsibble(index = game_date, key = c(home_team, away_team, game_time))


logs_tsibble <- logs_tsibble %>% left_join(schedules_tsibble)

```

expanded the line score variable out into inning information for each team. Removed variables that only had one level.

```{r clean-data}

logs_tsibble %>% mutate(
  visiting_inning_1 = substring(VisitingTeam_LineScore,1,1),
  visiting_inning_2 = substring(VisitingTeam_LineScore,2,2),
  visiting_inning_3 = substring(VisitingTeam_LineScore,3,3),
  visiting_inning_4 = substring(VisitingTeam_LineScore,4,4),
  visiting_inning_5 = substring(VisitingTeam_LineScore,5,5),
  visiting_inning_6 = substring(VisitingTeam_LineScore,6,6),
  visiting_inning_7 = substring(VisitingTeam_LineScore,7,7),
  visiting_inning_8 = substring(VisitingTeam_LineScore,8,8),
  visiting_inning_9 = substring(VisitingTeam_LineScore,9,9),
  home_inning_1 = substring(HomeTeam_LineScore,1,1),
  home_inning_2 = substring(HomeTeam_LineScore,2,2),
  home_inning_3 = substring(HomeTeam_LineScore,3,3),
  home_inning_4 = substring(HomeTeam_LineScore,4,4),
  home_inning_5 = substring(HomeTeam_LineScore,5,5),
  home_inning_6 = substring(HomeTeam_LineScore,6,6),
  home_inning_7 = substring(HomeTeam_LineScore,7,7),
  home_inning_8 = substring(HomeTeam_LineScore,8,8),
  home_inning_9 = substring(HomeTeam_LineScore,9,9),
  extra_innings = ifelse(str_length(VisitingTeam_LineScore) > 9 | str_length(HomeTeam_LineScore) > 9, TRUE, FALSE)
) 

test <- logs_tsibble %>%
  select(HomeTeam, VisitingTeam, VisitingTeamGameNumber, HomeTeamGameNumber) %>%
  arrange(Date)






teams <- unique(test$HomeTeam)

total_tibble <- test %>% filter(is.na(HomeTeam))

for (team in teams) {
  team_tibble <- test %>% 
    filter(HomeTeam == team | VisitingTeam == team) %>%
    mutate(home_streak = -1,
           away_streak = -1)
  
  for (i in 1:nrow(team_tibble)){
    row <- team_tibble[i,]
    
    if (row$VisitingTeam == team){
      if (row$away_streak == -1){
        team_tibble$away_streak[i] <- 1
      } 
      else{
        team_tibble$away_streak[i] <- team_tibble$away_streak[i-1] + 1
      } 
      team_tibble$home_streak[i] <- 0;
    }
    else if (row$HomeTeam == team){
      if (row$home_streak == -1){
        team_tibble$home_streak[i] <- 1
      } 
      else{
        team_tibble$home_streak[i] <- team_tibble$home_streak[i-1] + 1
      } 
      team_tibble$away_streak[i] <- 0;
    }
  }
  
  total_tibble <- bind_rows(total_tibble, team_tibble)
}

cleaned_logs <- logs_tsibble%>%
  as_tibble() %>%
  arrange(Date) %>%
  select(NumberofGames, DayofWeek, VisitingTeam, VisitingTeamLeague, VisitingTeamGameNumber, HomeTeam, HomeTeamLeague, HomeTeamGameNumber, DayNight, Attendance, Date)

# Pivoted Tibble

cleaned_logs %>% 
  pivot_longer(c(VisitingTeam, HomeTeam), names_to = "Visiting_Home", values_to = "Team") %>%
  mutate(GameNumber = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamGameNumber, HomeTeamGameNumber),
         Leauge = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamLeague, HomeTeamLeague)) %>%
  select(-HomeTeamGameNumber, -VisitingTeamGameNumber, -VisitingTeamLeague, -HomeTeamLeague)

```

```{r correlation}

cleaned_logs %>%
  ggplot(aes(x=VisitingTeamGameNumber, y = Attendance)) + 
  geom_point()
cleaned_logs %>%
  ggplot(aes(x=HomeTeamGameNumber, y = Attendance)) + 
  geom_point()

```

```{r forward-backward-selection}

set.seed(1995)

train <- sample(c(T,F), nrow(cleaned_logs), replace = T)
test <- !train

regfit.best <- regsubsets(Attendance ~ ., data = cleaned_logs[train,], nvmax = 150)

```

```{r ridge-lasso}

x <- model.matrix(Attendance ~ ., cleaned_logs)[,-1]
y <- cleaned_logs$Attendance

```
