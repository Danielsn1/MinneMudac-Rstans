---
title: "Nathan EDA"
author: "Nathan Daniels"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r load-packages}
library(readr)
library(tidyverse)
library(tsibble)
library(GGally)
library(leaps)
library(glmnet)
library(patchwork)
```


```{r load-data}

schedules <- read_csv("../data/OriginalSchedules.csv", locale = locale(encoding = "utf-16"))
logs <- read_csv("../data/GameLogs.csv", locale = locale(encoding = "utf-16"))
mlb_schedule <- read_csv("../data/2023_MLBSchedule.csv")

```

Changed the dates into a R format

```{r create-timeseries}

schedules_tsibble <- schedules %>% 
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>%
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

logs_tsibble <- logs %>%
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>% 
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

mlb_schedule_tsibble <- mlb_schedule %>%
  mutate(game_date = as.Date(as.character(game_date), format="%Y%m%d")) %>%
  as_tsibble(index = game_date, key = c(home_team, away_team, game_time))


logs_tsibble <- logs_tsibble %>% left_join(schedules_tsibble)

```

expanded the line score variable out into inning information for each team. Removed variables that only had one level.

```{r clean-data}

cleaned_logs <- logs_tsibble%>%
  as_tibble() %>%
  arrange(Date) %>%
  select(NumberofGames, DayofWeek, VisitingTeam, VisitingTeamLeague, VisitingTeamGameNumber, HomeTeam, HomeTeamLeague, HomeTeamGameNumber, DayNight, Attendance, Date, BallParkID)

# Pivoted Tibble

pivoted_logs <- cleaned_logs %>% 
  pivot_longer(c(VisitingTeam, HomeTeam), names_to = "Visiting_Home", values_to = "Team") %>%
  mutate(GameNumber = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamGameNumber, HomeTeamGameNumber),
         Leauge = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamLeague, HomeTeamLeague)) %>%
  select(-HomeTeamGameNumber, -VisitingTeamGameNumber, -VisitingTeamLeague, -HomeTeamLeague)


test <- pivoted_logs %>%
  select(Team, GameNumber, Date, Visiting_Home) %>%
  arrange(Date)

teams <- unique(test$Team)

total_tibble <- test %>% filter(is.na(Team))

for (team in teams) {
  team_tibble <- test %>% 
    filter(Team == team) %>%
    mutate(home_streak = 0,
           away_streak = 0)
  
  for (i in 1:nrow(team_tibble)){
    row <- team_tibble[i,]
    
    if (row$Visiting_Home == "VisitingTeam"){
      if (i == 1){
        team_tibble$away_streak[i] <- 1
      } 
      else{
        team_tibble$away_streak[i] <- team_tibble$away_streak[i-1] + 1
      } 
      team_tibble$home_streak[i] <- 0;
    }
    else{
      if (i == 1){
        team_tibble$home_streak[i] <- 1
      } 
      else{
        team_tibble$home_streak[i] <- team_tibble$home_streak[i-1] + 1
      } 
      team_tibble$away_streak[i] <- 0;
    }
  }
  
  total_tibble <- bind_rows(total_tibble, team_tibble)
}

completed_logs <- full_join(total_tibble, pivoted_logs)

```

```{r correlation}

box <- completed_logs %>%
  ggplot(aes(x = Attendance, y = as.factor(home_streak))) + 
  geom_boxplot() 
hist <- completed_logs %>%
  ggplot(aes(x=home_streak)) +
  geom_histogram()

box/hist

box <- completed_logs %>%
  ggplot(aes(x = Attendance, y = as.factor(away_streak))) + 
  geom_boxplot() 
hist <- completed_logs %>%
  ggplot(aes(x=away_streak)) +
  geom_histogram()

box/hist

```

```{r distance}

unique(cleaned_logs$BallParkID)

home_stadiums <- data.frame(
  team = c("NYN",),
  home_stadium = c("")
)



```

```{r forward-backward-selection}

set.seed(1995)

train <- sample(c(T,F), nrow(cleaned_logs), replace = T)
test <- !train

regfit.best <- regsubsets(Attendance ~ ., data = cleaned_logs[train,], nvmax = 150)

```

```{r ridge-lasso}

x <- model.matrix(Attendance ~ ., cleaned_logs)[,-1]
y <- cleaned_logs$Attendance

```
