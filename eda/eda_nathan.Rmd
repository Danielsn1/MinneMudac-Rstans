---
title: "Nathan EDA"
author: "Nathan Daniels"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r load-packages}
library(readr)
library(tidyverse)
library(tsibble)
library(GGally)
library(leaps)
library(glmnet)
library(patchwork)
```


```{r load-data}

schedules <- read_csv("../data/OriginalSchedules.csv", locale = locale(encoding = "utf-16"))
logs <- read_csv("../data/GameLogs.csv", locale = locale(encoding = "utf-16"))
mlb_schedule <- read_csv("../data/2023_MLBSchedule.csv")

```

Changed the dates into a R format

```{r create-timeseries}

schedules_tsibble <- schedules %>% 
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>%
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

logs_tsibble <- logs %>%
  mutate(Date = as.Date(as.character(Date), format="%Y%m%d")) %>% 
  as_tsibble(index = Date, key = c(VisitingTeam, HomeTeam, VisitingTeamGameNumber, HomeTeamGameNumber))

mlb_schedule_tsibble <- mlb_schedule %>%
  mutate(game_date = as.Date(as.character(game_date), format="%Y%m%d")) %>%
  as_tsibble(index = game_date, key = c(home_team, away_team, game_time))


logs_tsibble <- logs_tsibble %>% left_join(schedules_tsibble)

```

expanded the line score variable out into inning information for each team. Removed variables that only had one level.

```{r clean-data}

cleaned_logs <- logs_tsibble%>%
  as_tibble() %>%
  arrange(Date) %>%
  select(NumberofGames, DayofWeek, VisitingTeam, VisitingTeamLeague, VisitingTeamGameNumber, HomeTeam, HomeTeamLeague, HomeTeamGameNumber, DayNight, Attendance, Date, BallParkID)

# Pivoted Tibble

pivoted_logs <- cleaned_logs %>% 
  pivot_longer(c(VisitingTeam, HomeTeam), names_to = "Visiting_Home", values_to = "Team") %>%
  mutate(GameNumber = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamGameNumber, HomeTeamGameNumber),
         Leauge = ifelse(Visiting_Home == "VisitingTeam", VisitingTeamLeague, HomeTeamLeague)) %>%
  select(-HomeTeamGameNumber, -VisitingTeamGameNumber, -VisitingTeamLeague, -HomeTeamLeague)


test <- pivoted_logs %>%
  select(Team, GameNumber, Date, Visiting_Home) %>%
  arrange(Date)

teams <- unique(test$Team)

total_tibble <- test %>% filter(is.na(Team))

for (team in teams) {
  team_tibble <- test %>% 
    filter(Team == team) %>%
    mutate(home_streak = 0,
           away_streak = 0)
  
  for (i in 1:nrow(team_tibble)){
    row <- team_tibble[i,]
    
    if (row$Visiting_Home == "VisitingTeam"){
      if (i == 1){
        team_tibble$away_streak[i] <- 1
      } 
      else{
        team_tibble$away_streak[i] <- team_tibble$away_streak[i-1] + 1
      } 
      team_tibble$home_streak[i] <- 0;
    }
    else{
      if (i == 1){
        team_tibble$home_streak[i] <- 1
      } 
      else{
        team_tibble$home_streak[i] <- team_tibble$home_streak[i-1] + 1
      } 
      team_tibble$away_streak[i] <- 0;
    }
  }
  
  total_tibble <- bind_rows(total_tibble, team_tibble)
}

completed_logs <- full_join(total_tibble, pivoted_logs)

```

```{r correlation}

box <- completed_logs %>%
  ggplot(aes(x = Attendance, y = as.factor(home_streak))) + 
  geom_boxplot() 
hist <- completed_logs %>%
  ggplot(aes(x=home_streak)) +
  geom_histogram()

box/hist

box <- completed_logs %>%
  ggplot(aes(x = Attendance, y = as.factor(away_streak))) + 
  geom_boxplot() 
hist <- completed_logs %>%
  ggplot(aes(x=away_streak)) +
  geom_histogram()

box/hist

```

```{r distance}

unique(cleaned_logs$BallParkID)

team_locations <- data.frame(
  team = c("NYN",),
  team_location = c()
)

stadium_locations <- data.frame(
  stadium = unique(completed_logs$BallParkID),
  stadium_location = c(c())
  
)



```

```{r forward-backward-selection}

set.seed(1995)

train <- sample(c(T,F), nrow(completed_logs), replace = T)
test <- !train

reg.best <- regsubsets(Attendance ~ ., data = completed_logs[train,], nvmax = 100,
                           really.big = T)

forward.best <- regsubsets(Attendance ~ ., data = completed_logs[train,], nvmax = 100,
                           really.big = T, method = "forward")

backward.best <- regsubsets(Attendance ~ ., data = completed_logs[train,], nvmax = 100,
                            really.big = T, method = "backward")

fwd.sumry <- summary(forward.best)
bkwd.sumry <- summary(backward.best)

fwd.sumry$bic
bkwd.sumry$bic

which.min(fwd.sumry$bic)
which.min(bkwd.sumry$bic)

coef(backward.best, 65)
coef(forward.best, 71)

```

```{r ridge-lasso}

x <- model.matrix(Attendance ~ ., completed_logs)[,-1]
y <- completed_logs$Attendance

grid <- 10^ seq (10, -2, length = 100)

lasso.mod <- glmnet (x[train , ], y[train], alpha = 1,
  lambda = grid)

set.seed (1)
cv.out <- cv.glmnet(x[train , ], y[train], alpha = 1)

bestlam <- cv.out$lambda.min
lasso.pred <- predict (lasso.mod, s = bestlam,
  newx = x[test, ])



```
